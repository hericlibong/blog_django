{% extends "base.html" %}
{% load static %}


{% block title %}Assistant IA{% endblock %}

{% block content %}
<div class="container chat-container mt-5">
    <h2 class="text-center">Assistant IA</h2>
    <p class="text-center description">
        Interrogez moi sur mon parcours, mes expÃ©riences, ma reconversion, mes projets.
        qje vous rÃ©ponds ðŸ˜‰.
    </p>

    <div class="chat-box" id="chat-box"></div>

    <div class="input-group mt-3 chat-input">
        <input type="text" id="user-input" class="form-control" placeholder="Posez une question sur HÃ©ric..." autofocus>
        <button class="btn btn-primary" onclick="sendMessage()">Envoyer</button>
    </div>
</div>

<!-- Charge la librairie Marked.js AVANT ton script JS -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
function sendMessage() {
    let userMessage = document.getElementById("user-input").value;
    if (!userMessage.trim()) return;

    let chatBox = document.getElementById("chat-box");
    chatBox.innerHTML += `<div class="user-message"><strong>Vous :</strong> ${userMessage}</div>`;

    fetch("{% url 'openaichat:chatbot_response' %}", {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/x-www-form-urlencoded" },
        body: `message=${encodeURIComponent(userMessage)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.response) {
            const html = marked.parse(data.response);
            chatBox.innerHTML += `<div class="bot-message"><strong><img src="{% static 'favicon.ico' %}" style="width:25px; height:25px; border-radius:50%; margin-right:6px;" alt="HÃ©ric"></strong>${html}</div>`;


        } else {
            chatBox.innerHTML += `<div class="error-message">Erreur : ${data.error}</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight; // Scroll automatique vers le bas
    })
    .catch(err => {
        chatBox.innerHTML += `<div class="error-message">Erreur rÃ©seau ou serveur</div>`;
    });

    document.getElementById("user-input").value = "";
}
document.getElementById("user-input").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();  // EmpÃªche le saut de ligne dans le champ input
        sendMessage();
    }
});
</script>
{% endblock %}
